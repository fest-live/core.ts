import { cvt_cs_to_os } from "./Convert";
import { roundNearest } from "./Primitive";
//
const get = (items, id) => { if (typeof items?.get == "function") {
    const item = items?.get?.(id);
    if (item) {
        return item;
    }
    ;
} ; return Array.from(items?.values?.() || items || [])?.find?.((item) => (item?.id == id || item == id)); };
//
export const getSpan = (el, ax) => { const prop = el.style.getPropertyValue(["--ox-c-span", "--ox-r-span"][ax]), factor = ((parseFloat(prop || "1") || 1) - 1); return Math.min(Math.max(factor - 1, 0), 1); };
/**
 * Find a non-busy cell near the preferred cell in a grid layout.
 * If the preferred cell is busy, searches nearby cells to find an available one.
 * @param $preCell - Preferred cell coordinates [column, row]
 * @param gridArgs - Grid arguments containing items, layout, and size information
 * @returns Cell coordinates [column, row] that are not busy
 */
export const redirectCell = ($preCell, gridArgs) => {
    const icons = (gridArgs?.items || []);
    const item = gridArgs?.item || {};
    const checkBusy = (cell) => {
        return icons
            ?.filter?.((e) => !(e == item || e?.id == item?.id))
            ?.some?.((one) => ((one?.cell?.[0] || 0) == (cell[0] || 0) && (one?.cell?.[1] || 0) == (cell[1] || 0)));
    };
    //
    const preCell = [...$preCell]; // make non-conflict copy
    if (!checkBusy(preCell)) {
        return [...preCell];
    }
    const layout = [...gridArgs?.layout];
    const columns = layout[0] || 4;
    const rows = layout[1] || 8;
    const variants = [
        [preCell[0] + 1, preCell[1]],
        [preCell[0] - 1, preCell[1]],
        [preCell[0], preCell[1] + 1],
        [preCell[0], preCell[1] - 1],
    ].filter((v) => { return v[0] >= 0 && v[0] < columns && v[1] >= 0 && v[1] < rows; }) || [];
    const suitable = variants.find((v) => !checkBusy(v));
    if (suitable) {
        return [...suitable];
    }
    //
    let exceed = 0, busy = true, comp = [...preCell];
    while (busy && exceed++ < columns * rows) {
        if (!(busy = checkBusy(comp))) {
            return [...comp];
        }
        ;
        comp[0]++;
        if (comp[0] >= columns) {
            comp[0] = 0;
            comp[1]++;
            if (comp[1] >= rows) {
                comp[1] = 0;
            }
        }
    }
    return [...preCell];
};
/* LAST GENERATION... */
export const makeOrientInset = ($orientPx, gridArgs, orient = 0) => {
    const boxInPx = [...gridArgs.size];
    const orientPx = [...$orientPx];
    const layout = [...gridArgs.layout];
    if (orient % 2) {
        boxInPx.reverse();
    }
    ;
    return [
        roundNearest(orientPx[0], boxInPx[0] / layout[0]),
        roundNearest(orientPx[1], boxInPx[1] / layout[1])
    ];
};
/* LAST GENERATION... */
export const convertOrientPxToCX = ($orientPx, gridArgs, orient = 0) => {
    const boxInPx = [...gridArgs.size];
    const orientPx = [...$orientPx];
    const layout = [...gridArgs.layout];
    if (orient % 2) {
        boxInPx.reverse();
    }
    ;
    const gridPxToCX = [layout[0] / boxInPx[0], layout[1] / boxInPx[1]];
    return [orientPx[0] * gridPxToCX[0], orientPx[1] * gridPxToCX[1]];
};
// should be relative from grid-box (not absolute or fixed position)
export const floorInOrientPx = ($orientPx, gridArgs, orient = 0) => {
    const orientPx = [...$orientPx];
    const boxInPx = [...gridArgs.size];
    const layout = [...gridArgs.layout];
    if (orient % 2) {
        boxInPx.reverse();
    }
    ;
    const inBox = [boxInPx[0] / layout[0], boxInPx[1] / layout[1]];
    return [roundNearest(orientPx[0], inBox[0]), roundNearest(orientPx[1], inBox[1])];
};
//
export const floorInCX = ($CX, gridArgs) => {
    const layout = gridArgs.layout;
    return [
        Math.min(Math.max(roundNearest($CX[0]), 0), layout[0] - 1),
        Math.min(Math.max(roundNearest($CX[1]), 0), layout[1] - 1)
    ];
};
//
export const clientSpaceInOrientCX = ($clientPx, gridArgs, orient = 0) => {
    const clientPx = [...$clientPx];
    const size = [...gridArgs.size];
    //if (orient%2) { size.reverse(); };
    const orientPx = cvt_cs_to_os(clientPx, size, orient);
    return [
        Math.min(Math.max(roundNearest(orientPx[0] / size[0] * (gridArgs.layout[0]), 1), 0), gridArgs.layout[0] - 1),
        Math.min(Math.max(roundNearest(orientPx[1] / size[1] * (gridArgs.layout[1]), 1), 0), gridArgs.layout[1] - 1)
    ];
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiR3JpZEl0ZW1VdGlscy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkdyaWRJdGVtVXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUN6QyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRzNDLEVBQUU7QUFDRixNQUFNLEdBQUcsR0FBRyxDQUFDLEtBQUssRUFBRSxFQUFFLEVBQUMsRUFBRSxHQUFFLElBQUksT0FBTyxLQUFLLEVBQUUsR0FBRyxJQUFJLFVBQVUsRUFBRSxDQUFDO0lBQUMsTUFBTSxJQUFJLEdBQUcsS0FBSyxFQUFFLEdBQUcsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQztRQUFDLE9BQU8sSUFBSSxDQUFDO0lBQUMsQ0FBQztJQUFBLENBQUM7QUFBQyxDQUFDLENBQUEsQ0FBQyxDQUFDLE9BQU8sS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFLEVBQUUsSUFBRSxLQUFLLElBQUUsRUFBRSxDQUFDLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxJQUFTLEVBQUMsRUFBRSxDQUFBLENBQUMsSUFBSSxFQUFFLEVBQUUsSUFBSSxFQUFFLElBQUksSUFBSSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7QUFFdk8sRUFBRTtBQUNGLE1BQU0sQ0FBQyxNQUFNLE9BQU8sR0FBRyxDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUMsRUFBRSxHQUFFLE1BQU0sSUFBSSxHQUFHLEVBQUUsQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxhQUFhLEVBQUUsYUFBYSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxNQUFNLEdBQUcsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxJQUFJLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxD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QUMsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUMsR0FBQyxDQUFDLENBQUM7S0FDM0QsQ0FBQztBQUNOLENBQUMsQ0FBQTtBQUVELEVBQUU7QUFDRixNQUFNLENBQUMsTUFBTSxxQkFBcUIsR0FBRyxDQUFDLFNBQVMsRUFBRSxRQUFzQixFQUFFLFNBQWlCLENBQUMsRUFBb0IsRUFBRTtJQUM3RyxNQUFNLFFBQVEsR0FBcUIsQ0FBQyxHQUFHLFNBQVMsQ0FBcUIsQ0FBQztJQUN0RSxNQUFNLElBQUksR0FBcUIsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQXFCLENBQUM7SUFDdEUsb0NBQW9DO0lBQ3BDLE1BQU0sUUFBUSxHQUFHLFlBQVksQ0FBQyxRQUFRLEVBQUUsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQ3RELE9BQU87UUFDSCxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsR0FBQyxDQUFDLENBQUM7UUFDMUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEdBQUMsQ0FBQyxDQUFDO0tBQzdHLENBQUE7QUFDTCxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBjdnRfY3NfdG9fb3MgfSBmcm9tIFwiLi9Db252ZXJ0XCI7XG5pbXBvcnQgeyByb3VuZE5lYXJlc3QgfSBmcm9tIFwiLi9QcmltaXRpdmVcIjtcbmltcG9ydCB0eXBlIHsgR3JpZEFyZ3NUeXBlLCBHcmlkSXRlbVR5cGUgfSBmcm9tIFwiLi9UeXBlc1wiO1xuXG4vL1xuY29uc3QgZ2V0ID0gKGl0ZW1zLCBpZCk9PnsgaWYgKHR5cGVvZiBpdGVtcz8uZ2V0ID09IFwiZnVuY3Rpb25cIikgeyBjb25zdCBpdGVtID0gaXRlbXM/LmdldD8uKGlkKTsgaWYgKGl0ZW0pIHsgcmV0dXJuIGl0ZW07IH07IH07IHJldHVybiBBcnJheS5mcm9tKGl0ZW1zPy52YWx1ZXM/LigpfHxpdGVtc3x8W10pPy5maW5kPy4oKGl0ZW06IGFueSk9PihpdGVtPy5pZCA9PSBpZCB8fCBpdGVtID09IGlkKSk7IH1cblxuLy9cbmV4cG9ydCBjb25zdCBnZXRTcGFuID0gKGVsLCBheCk9PnsgY29uc3QgcHJvcCA9IGVsLnN0eWxlLmdldFByb3BlcnR5VmFsdWUoW1wiLS1veC1jLXNwYW5cIiwgXCItLW94LXItc3BhblwiXVtheF0pLCBmYWN0b3IgPSAoKHBhcnNlRmxvYXQocHJvcCB8fCBcIjFcIikgfHwgMSkgLSAxKTsgcmV0dXJuIE1hdGgubWluKE1hdGgubWF4KGZhY3Rvci0xLCAwKSwgMSk7IH1cbi8qKlxuICogRmluZCBhIG5vbi1idXN5IGNlbGwgbmVhciB0aGUgcHJlZmVycmVkIGNlbGwgaW4gYSBncmlkIGxheW91dC5cbiAqIElmIHRoZSBwcmVmZXJyZWQgY2VsbCBpcyBidXN5LCBzZWFyY2hlcyBuZWFyYnkgY2VsbHMgdG8gZmluZCBhbiBhdmFpbGFibGUgb25lLlxuICogQHBhcmFtICRwcmVDZWxsIC0gUHJlZmVycmVkIGNlbGwgY29vcmRpbmF0ZXMgW2NvbHVtbiwgcm93XVxuICogQHBhcmFtIGdyaWRBcmdzIC0gR3JpZCBhcmd1bWVudHMgY29udGFpbmluZyBpdGVtcywgbGF5b3V0LCBhbmQgc2l6ZSBpbmZvcm1hdGlvblxuICogQHJldHVybnMgQ2VsbCBjb29yZGluYXRlcyBbY29sdW1uLCByb3ddIHRoYXQgYXJlIG5vdCBidXN5XG4gKi9cbmV4cG9ydCBjb25zdCByZWRpcmVjdENlbGwgPSAoJHByZUNlbGw6IFtudW1iZXIsIG51bWJlcl0sIGdyaWRBcmdzOiBHcmlkQXJnc1R5cGUpOiBbbnVtYmVyLCBudW1iZXJdID0+IHtcbiAgICBjb25zdCBpY29uczogYW55ID0gKGdyaWRBcmdzPy5pdGVtcyB8fCBbXSk7XG4gICAgY29uc3QgaXRlbSA9IGdyaWRBcmdzPy5pdGVtIHx8IHt9O1xuICAgIGNvbnN0IGNoZWNrQnVzeSA9IChjZWxsKTogYm9vbGVhbiA9PiB7XG4gICAgICAgIHJldHVybiBpY29uc1xuICAgICAgICAgICAgPy5maWx0ZXI/LigoZTogR3JpZEl0ZW1UeXBlKSA9PiAhKGUgPT0gaXRlbSB8fCBlPy5pZCA9PSBpdGVtPy5pZCkpXG4gICAgICAgICAgICA/LnNvbWU/Ligob25lKSA9PiAoKG9uZT8uY2VsbD8uWzBdfHwwKSA9PSAoY2VsbFswXXx8MCkgJiYgKG9uZT8uY2VsbD8uWzFdfHwwKSA9PSAoY2VsbFsxXXx8MCkpKTtcbiAgICB9O1xuXG4gICAgLy9cbiAgICBjb25zdCBwcmVDZWxsOiBbbnVtYmVyLCBudW1iZXJdID0gWy4uLiRwcmVDZWxsXTsgLy8gbWFrZSBub24tY29uZmxpY3QgY29weVxuICAgIGlmICghY2hlY2tCdXN5KHByZUNlbGwpKSB7IHJldHVybiBbLi4ucHJlQ2VsbF07IH1cbiAgICBjb25zdCBsYXlvdXQgID0gWy4uLmdyaWRBcmdzPy5sYXlvdXRdO1xuICAgIGNvbnN0IGNvbHVtbnMgPSBsYXlvdXRbMF0gfHwgNDtcbiAgICBjb25zdCByb3dzICAgID0gbGF5b3V0WzFdIHx8IDg7XG4gICAgY29uc3QgdmFyaWFudHM6IFtudW1iZXIsIG51bWJlcl1bXSA9IFtcbiAgICAgICAgW3ByZUNlbGxbMF0gKyAxLCBwcmVDZWxsWzFdXSBhcyBbbnVtYmVyLCBudW1iZXJdLFxuICAgICAgICBbcHJlQ2VsbFswXSAtIDEsIHByZUNlbGxbMV1dIGFzIFtudW1iZXIsIG51bWJlcl0sXG4gICAgICAgIFtwcmVDZWxsWzBdLCBwcmVDZWxsWzFdICsgMV0gYXMgW251bWJlciwgbnVtYmVyXSxcbiAgICAgICAgW3ByZUNlbGxbMF0sIHByZUNlbGxbMV0gLSAxXSBhcyBbbnVtYmVyLCBudW1iZXJdLFxuICAgIF0uZmlsdGVyKCh2KSA9PiB7IHJldHVybiB2WzBdID49IDAgJiYgdlswXSA8IGNvbHVtbnMgJiYgdlsxXSA+PSAwICYmIHZbMV0gPCByb3dzOyB9KSB8fCBbXTtcbiAgICBjb25zdCBzdWl0YWJsZSA9IHZhcmlhbnRzLmZpbmQoKHYpID0+ICFjaGVja0J1c3kodikpOyBpZiAoc3VpdGFibGUpIHsgcmV0dXJuIFsuLi5zdWl0YWJsZV07IH1cblxuICAgIC8vXG4gICAgbGV0IGV4Y2VlZCA9IDAsIGJ1c3kgPSB0cnVlLCBjb21wID0gWy4uLnByZUNlbGxdO1xuICAgIHdoaWxlIChidXN5ICYmIGV4Y2VlZCsrIDwgY29sdW1ucyAqIHJvd3MpIHtcbiAgICAgICAgaWYgKCEoYnVzeSA9IGNoZWNrQnVzeShjb21wKSkpIHsgcmV0dXJuIFsuLi5jb21wXSBhcyBbbnVtYmVyLCBudW1iZXJdOyB9OyBjb21wWzBdKys7XG4gICAgICAgIGlmIChjb21wWzBdID49IGNvbHVtbnMpIHsgY29tcFswXSA9IDA7IGNvbXBbMV0rKzsgaWYgKGNvbXBbMV0gPj0gcm93cykgIHsgY29tcFsxXSA9IDA7IH0gfVxuICAgIH1cbiAgICByZXR1cm4gWy4uLnByZUNlbGxdO1xufVxuXG5cblxuLyogTEFTVCBHRU5FUkFUSU9OLi4uICovXG5leHBvcnQgY29uc3QgbWFrZU9yaWVudEluc2V0ID0gKCRvcmllbnRQeDogW251bWJlciwgbnVtYmVyXSwgZ3JpZEFyZ3M6IEdyaWRBcmdzVHlwZSwgb3JpZW50OiBudW1iZXIgPSAwKTogW251bWJlciwgbnVtYmVyXSA9PiB7XG4gICAgY29uc3QgYm94SW5QeCA9IFsuLi5ncmlkQXJncy5zaXplXTtcbiAgICBjb25zdCBvcmllbnRQeDogW251bWJlciwgbnVtYmVyXSA9IFsuLi4kb3JpZW50UHhdO1xuICAgIGNvbnN0IGxheW91dCA9IFsuLi5ncmlkQXJncy5sYXlvdXRdO1xuICAgIGlmIChvcmllbnQlMikgeyBib3hJblB4LnJldmVyc2UoKTsgfTtcbiAgICByZXR1cm4gW1xuICAgICAgICByb3VuZE5lYXJlc3Qob3JpZW50UHhbMF0sIGJveEluUHhbMF0gLyBsYXlvdXRbMF0pLFxuICAgICAgICByb3VuZE5lYXJlc3Qob3JpZW50UHhbMV0sIGJveEluUHhbMV0gLyBsYXlvdXRbMV0pXG4gICAgXTtcbn1cblxuXG5cblxuLyogTEFTVCBHRU5FUkFUSU9OLi4uICovXG5leHBvcnQgY29uc3QgY29udmVydE9yaWVudFB4VG9DWCA9ICgkb3JpZW50UHg6IFtudW1iZXIsIG51bWJlcl0sIGdyaWRBcmdzOiBHcmlkQXJnc1R5cGUsIG9yaWVudDogbnVtYmVyID0gMCk6IFtudW1iZXIsIG51bWJlcl0gPT4ge1xuICAgIGNvbnN0IGJveEluUHggPSBbLi4uZ3JpZEFyZ3Muc2l6ZV07XG4gICAgY29uc3Qgb3JpZW50UHg6IFtudW1iZXIsIG51bWJlcl0gPSBbLi4uJG9yaWVudFB4XTtcbiAgICBjb25zdCBsYXlvdXQgPSBbLi4uZ3JpZEFyZ3MubGF5b3V0XTtcbiAgICBpZiAob3JpZW50JTIpIHsgYm94SW5QeC5yZXZlcnNlKCk7IH07XG4gICAgY29uc3QgZ3JpZFB4VG9DWCA9IFtsYXlvdXRbMF0gLyBib3hJblB4WzBdLCBsYXlvdXRbMV0gLyBib3hJblB4WzFdXTtcbiAgICByZXR1cm4gW29yaWVudFB4WzBdICogZ3JpZFB4VG9DWFswXSwgb3JpZW50UHhbMV0gKiBncmlkUHhUb0NYWzFdXVxufVxuXG4vLyBzaG91bGQgYmUgcmVsYXRpdmUgZnJvbSBncmlkLWJveCAobm90IGFic29sdXRlIG9yIGZpeGVkIHBvc2l0aW9uKVxuZXhwb3J0IGNvbnN0IGZsb29ySW5PcmllbnRQeCA9ICgkb3JpZW50UHg6IFtudW1iZXIsIG51bWJlcl0sIGdyaWRBcmdzOiBHcmlkQXJnc1R5cGUsIG9yaWVudDogbnVtYmVyID0gMCkgPT4ge1xuICAgIGNvbnN0IG9yaWVudFB4OiBbbnVtYmVyLCBudW1iZXJdID0gWy4uLiRvcmllbnRQeF07XG4gICAgY29uc3QgYm94SW5QeCA9IFsuLi5ncmlkQXJncy5zaXplXTtcbiAgICBjb25zdCBsYXlvdXQgPSBbLi4uZ3JpZEFyZ3MubGF5b3V0XTtcbiAgICBpZiAob3JpZW50JTIpIHsgYm94SW5QeC5yZXZlcnNlKCk7IH07XG4gICAgY29uc3QgaW5Cb3ggPSBbYm94SW5QeFswXSAvIGxheW91dFswXSwgYm94SW5QeFsxXSAvIGxheW91dFsxXV07XG4gICAgcmV0dXJuIFtyb3VuZE5lYXJlc3Qob3JpZW50UHhbMF0sIGluQm94WzBdKSwgcm91bmROZWFyZXN0KG9yaWVudFB4WzFdLCBpbkJveFsxXSldO1xufVxuXG4vL1xuZXhwb3J0IGNvbnN0IGZsb29ySW5DWCA9ICgkQ1g6IFtudW1iZXIsIG51bWJlcl0sIGdyaWRBcmdzOiBHcmlkQXJnc1R5cGUpOiBbbnVtYmVyLCBudW1iZXJdID0+IHtcbiAgICBjb25zdCBsYXlvdXQgPSBncmlkQXJncy5sYXlvdXQ7XG4gICAgcmV0dXJuIFtcbiAgICAgICAgTWF0aC5taW4oTWF0aC5tYXgocm91bmROZWFyZXN0KCRDWFswXSksIDApLCBsYXlvdXRbMF0tMSksXG4gICAgICAgIE1hdGgubWluKE1hdGgubWF4KHJvdW5kTmVhcmVzdCgkQ1hbMV0pLCAwKSwgbGF5b3V0WzFdLTEpXG4gICAgXTtcbn1cblxuLy9cbmV4cG9ydCBjb25zdCBjbGllbnRTcGFjZUluT3JpZW50Q1ggPSAoJGNsaWVudFB4LCBncmlkQXJnczogR3JpZEFyZ3NUeXBlLCBvcmllbnQ6IG51bWJlciA9IDApOiBbbnVtYmVyLCBudW1iZXJdID0+IHtcbiAgICBjb25zdCBjbGllbnRQeDogW251bWJlciwgbnVtYmVyXSA9IFsuLi4kY2xpZW50UHhdIGFzIFtudW1iZXIsIG51bWJlcl07XG4gICAgY29uc3Qgc2l6ZTogW251bWJlciwgbnVtYmVyXSA9IFsuLi5ncmlkQXJncy5zaXplXSBhcyBbbnVtYmVyLCBudW1iZXJdO1xuICAgIC8vaWYgKG9yaWVudCUyKSB7IHNpemUucmV2ZXJzZSgpOyB9O1xuICAgIGNvbnN0IG9yaWVudFB4ID0gY3Z0X2NzX3RvX29zKGNsaWVudFB4LCBzaXplLCBvcmllbnQpO1xuICAgIHJldHVybiBbXG4gICAgICAgIE1hdGgubWluKE1hdGgubWF4KHJvdW5kTmVhcmVzdChvcmllbnRQeFswXSAvIHNpemVbMF0gKiAoZ3JpZEFyZ3MubGF5b3V0WzBdKSwgMSksIDApLCBncmlkQXJncy5sYXlvdXRbMF0tMSksXG4gICAgICAgIE1hdGgubWluKE1hdGgubWF4KHJvdW5kTmVhcmVzdChvcmllbnRQeFsxXSAvIHNpemVbMV0gKiAoZ3JpZEFyZ3MubGF5b3V0WzFdKSwgMSksIDApLCBncmlkQXJncy5sYXlvdXRbMV0tMSlcbiAgICBdXG59O1xuIl19