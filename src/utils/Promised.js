import { unwrap, isPrimitive, tryParseByHint, fixFx } from "./Primitive";
//
const resolvedMap = new WeakMap(), handledMap = new WeakMap();
const actWith = (promiseOrPlain, cb) => {
    if (promiseOrPlain instanceof Promise || typeof promiseOrPlain?.then == "function") {
        if (resolvedMap?.has?.(promiseOrPlain)) {
            return cb(resolvedMap?.get?.(promiseOrPlain));
        }
        // @ts-ignore
        return Promise.try?.(async () => {
            const item = await promiseOrPlain;
            resolvedMap?.set?.(promiseOrPlain, item);
            return item;
        })?.then?.(cb);
    }
    return cb(promiseOrPlain);
};
//
class PromiseHandler {
    #resolve;
    #reject;
    //
    constructor(resolve, reject) {
        this.#resolve = resolve;
        this.#reject = reject;
    }
    //
    defineProperty(target, prop, descriptor) {
        if (unwrap(target) instanceof Promise)
            return Reflect.defineProperty(target, prop, descriptor);
        return actWith(unwrap(target), (obj) => Reflect.defineProperty(obj, prop, descriptor));
    }
    //
    deleteProperty(target, prop) {
        if (unwrap(target) instanceof Promise)
            return Reflect.deleteProperty(target, prop);
        return actWith(unwrap(target), (obj) => Reflect.deleteProperty(obj, prop));
    }
    //
    getPrototypeOf(target) {
        if (unwrap(target) instanceof Promise)
            return Reflect.getPrototypeOf(target);
        return actWith(unwrap(target), (obj) => Reflect.getPrototypeOf(obj));
    }
    //
    setPrototypeOf(target, proto) {
        if (unwrap(target) instanceof Promise)
            return Reflect.setPrototypeOf(target, proto);
        return actWith(unwrap(target), (obj) => Reflect.setPrototypeOf(obj, proto));
    }
    //
    isExtensible(target) {
        if (unwrap(target) instanceof Promise)
            return Reflect.isExtensible(target);
        return actWith(unwrap(target), (obj) => Reflect.isExtensible(obj));
    }
    //
    preventExtensions(target) {
        if (unwrap(target) instanceof Promise)
            return Reflect.ownKeys(target);
        return actWith(unwrap(target), (obj) => Reflect.preventExtensions(obj));
    }
    //
    ownKeys(target) {
        const uwp = unwrap(target);
        if (uwp instanceof Promise)
            return Object.keys(uwp);
        const keys = actWith(uwp, (obj) => { return (typeof obj == "object" || typeof obj == "function") && obj != null ? Object.keys(obj) : []; });
        return keys ?? [];
    }
    //
    getOwnPropertyDescriptor(target, prop) {
        if (unwrap(target) instanceof Promise)
            return Reflect.getOwnPropertyDescriptor(target, prop);
        return actWith(unwrap(target), (obj) => Reflect.getOwnPropertyDescriptor(obj, prop));
    }
    //
    construct(target, args, newTarget) {
        return actWith(unwrap(target), (ct) => Reflect.construct(ct, args, newTarget));
    }
    //
    has(target, prop) {
        if (unwrap(target) instanceof Promise)
            return Reflect.has(target, prop);
        return actWith(unwrap(target), (obj) => Reflect.has(obj, prop));
    }
    //
    get(target, prop, receiver) {
        target = unwrap(target);
        //
        if (prop == 'promise') {
            return target;
        } // @ts-ignore
        if (prop == 'resolve' && this.#resolve) {
            return (...args) => { const result = this.#resolve?.(...args); this.#resolve = null; return result; };
        } // @ts-ignore
        if (prop == 'reject' && this.#reject) {
            return (...args) => { const result = this.#reject?.(...args); this.#reject = null; return result; };
        } // @ts-ignore
        if (prop == 'then' || prop == 'catch' || prop == 'finally') {
            if (target instanceof Promise) {
                return target?.[prop]?.bind?.(target);
            }
            else {
                const $tmp = Promise.try(() => target);
                return $tmp?.[prop]?.bind?.($tmp);
            }
        }
        // @ts-ignore
        const result = Promised(actWith(target, async (obj) => {
            if (unwrap(obj) instanceof Promise)
                return Reflect.get(obj, prop, receiver);
            if (isPrimitive(obj)) {
                return (prop == Symbol.toPrimitive || prop == Symbol.toStringTag) ? obj : undefined;
            }
            let value = undefined;
            try {
                value = Reflect.get(obj, prop, receiver);
            }
            catch (e) {
                value = target?.[prop];
            }
            if (typeof value == 'function') {
                return value?.bind?.(obj);
            }
            return value;
        }));
        //
        if (prop == Symbol.toStringTag) {
            if (isPrimitive(result)) {
                return String(result ?? "") || "";
            }
            ;
            return result?.[Symbol.toStringTag]?.() || String(result ?? "") || "";
        }
        //
        if (prop == Symbol.toPrimitive) {
            return (hint) => {
                if (isPrimitive(result)) {
                    return tryParseByHint(result, hint);
                }
                ;
                return null; //tryParseByHint(result?.[Symbol.toPrimitive]?.());
            };
        }
        //
        return result;
    }
    //
    set(target, prop, value) {
        return actWith(unwrap(target), (obj) => Reflect.set(obj, prop, value));
    }
    //
    apply(target, thisArg, args) {
        if (this.#resolve) {
            const result = this.#resolve?.(...args);
            this.#resolve = null;
            return result;
        }
        return actWith(unwrap(target, this.#resolve), (obj) => {
            if (typeof obj == "function") {
                if (unwrap(obj) instanceof Promise)
                    return Reflect.apply(obj, thisArg, args);
                return Reflect.apply(obj, thisArg, args);
            }
        });
    }
}
/**
 * Wrap a promise or value in a Proxy that allows synchronous property access.
 * For resolved promises, this enables accessing properties as if the promise was already resolved.
 * @template T - The resolved value type
 * @param promise - The promise or value to wrap
 * @param resolve - Optional resolve callback
 * @param reject - Optional reject callback
 * @returns A proxy that allows synchronous-style access to promise values
 */
export function Promised(promise, resolve, reject) {
    if (!(promise instanceof Promise || typeof promise?.then == "function")) {
        return promise;
    }
    if (resolvedMap?.has?.(promise)) {
        return resolvedMap?.get?.(promise);
    }
    ;
    if (!handledMap?.has?.(promise)) {
        promise?.then?.((item) => resolvedMap?.set?.(promise, item));
    } // @ts-ignore
    return handledMap?.getOrInsertComputed?.(promise, () => new Proxy(fixFx(promise), new PromiseHandler(resolve, reject)));
}
//if (["then", "catch", "finally"].includes(prop as string)) { return (typeof withUpdate?.[prop] == "function" ? withUpdate?.[prop]?.bind?.(withUpdate) : withUpdate?.[prop]); }
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUHJvbWlzZWQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJQcm9taXNlZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFdBQVcsRUFBRSxjQUFjLEVBQUUsS0FBSyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRXpFLEVBQUU7QUFDRixNQUFNLFdBQVcsR0FBRyxJQUFJLE9BQU8sRUFBRSxFQUFFLFVBQVUsR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDO0FBQzlELE1BQU0sT0FBTyxHQUFHLENBQUMsY0FBYyxFQUFFLEVBQUUsRUFBQyxFQUFFO0lBQ2xDLElBQUksY0FBYyxZQUFZLE9BQU8sSUFBSSxPQUFPLGNBQWMsRUFBRSxJQUFJLElBQUksVUFBVSxFQUFFLENBQUM7UUFDakYsSUFBSSxXQUFXLEVBQUUsR0FBRyxFQUFFLENBQUMsY0FBYyxDQUFDLEVBQUUsQ0FBQztZQUFDLE9BQU8sRUFBRSxDQUFDLFdBQVcsRUFBRSxHQUFHLEVBQUUsQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDO1FBQUMsQ0FBQztRQUMxRixhQUFhO1FBQ2IsT0FBTyxPQUFPLENBQUMsR0FBRyxFQUFFLENBQUMsS0FBSyxJQUFHLEVBQUU7WUFDM0IsTUFBTSxJQUFJLEdBQUcsTUFBTSxjQUFjLENBQUM7WUFDbEMsV0FBVyxFQUFFLEdBQUcsRUFBRSxDQUFDLGNBQWMsRUFBRSxJQUFJLENBQUMsQ0FBQztZQUN6QyxPQUFPLElBQUksQ0FBQztRQUNoQixDQUFDLENBQUMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUNuQixDQUFDO0lBQ0QsT0FBTyxFQUFFLENBQUMsY0FBYyxDQUFDLENBQUM7QUFDOUIsQ0FBQyxDQUFBO0FBRUQsRUFBRTtBQUNGLE1BQU0sY0FBYztJQUNoQixRQUFRLENBQWlDO0lBQ3pDLE9BQU8sQ0FBaUM7SUFFeEMsRUFBRTtJQUNGLFlBQVksT0FBdUMsRUFBRSxNQUFzQztRQUN2RixJQUFJLENB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QUUsQ0FBQSxXQUFXLEVBQUUsR0FBRyxFQUFFLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7SUFBQyxDQUFDLENBQUMsYUFBYTtJQUM5RyxPQUFPLFVBQVUsRUFBRSxtQkFBbUIsRUFBRSxDQUFDLE9BQU8sRUFBRSxHQUFFLEVBQUUsQ0FBQSxJQUFJLEtBQUssQ0FBaUIsS0FBSyxDQUFDLE9BQU8sQ0FBQyxFQUFFLElBQUksY0FBYyxDQUFDLE9BQU8sRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDMUksQ0FBQztBQUVELGdMQUFnTCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHVud3JhcCwgaXNQcmltaXRpdmUsIHRyeVBhcnNlQnlIaW50LCBmaXhGeCB9IGZyb20gXCIuL1ByaW1pdGl2ZVwiO1xuXG4vL1xuY29uc3QgcmVzb2x2ZWRNYXAgPSBuZXcgV2Vha01hcCgpLCBoYW5kbGVkTWFwID0gbmV3IFdlYWtNYXAoKTtcbmNvbnN0IGFjdFdpdGggPSAocHJvbWlzZU9yUGxhaW4sIGNiKT0+e1xuICAgIGlmIChwcm9taXNlT3JQbGFpbiBpbnN0YW5jZW9mIFByb21pc2UgfHwgdHlwZW9mIHByb21pc2VPclBsYWluPy50aGVuID09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICBpZiAocmVzb2x2ZWRNYXA/Lmhhcz8uKHByb21pc2VPclBsYWluKSkgeyByZXR1cm4gY2IocmVzb2x2ZWRNYXA/LmdldD8uKHByb21pc2VPclBsYWluKSk7IH1cbiAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICByZXR1cm4gUHJvbWlzZS50cnk/Lihhc3luYyAoKT0+e1xuICAgICAgICAgICAgY29uc3QgaXRlbSA9IGF3YWl0IHByb21pc2VPclBsYWluO1xuICAgICAgICAgICAgcmVzb2x2ZWRNYXA/LnNldD8uKHByb21pc2VPclBsYWluLCBpdGVtKTtcbiAgICAgICAgICAgIHJldHVybiBpdGVtO1xuICAgICAgICB9KT8udGhlbj8uKGNiKTtcbiAgICB9XG4gICAgcmV0dXJuIGNiKHByb21pc2VPclBsYWluKTtcbn1cblxuLy9cbmNsYXNzIFByb21pc2VIYW5kbGVyIHtcbiAgICAjcmVzb2x2ZT86ICgoLi4uYXJnczogYW55W10pPT52b2lkKXxudWxsO1xuICAgICNyZWplY3Q/OiAoKC4uLmFyZ3M6IGFueVtdKT0+dm9pZCl8bnVsbDtcblxuICAgIC8vXG4gICAgY29uc3RydWN0b3IocmVzb2x2ZT86ICgoLi4uYXJnczogYW55W10pPT52b2lkKXxudWxsLCByZWplY3Q/OiAoKC4uLmFyZ3M6IGFueVtdKT0+dm9pZCl8bnVsbCkge1xuICAgICAgICB0aGlzLiNyZXNvbHZlID0gcmVzb2x2ZTtcbiAgICAgICAgdGhpcy4jcmVqZWN0ID0gcmVqZWN0O1xuICAgIH1cblxuICAgIC8vXG4gICAgZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBwcm9wLCBkZXNjcmlwdG9yKSB7XG4gICAgICAgIGlmICh1bndyYXAodGFyZ2V0KSBpbnN0YW5jZW9mIFByb21pc2UpIHJldHVybiBSZWZsZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgcHJvcCwgZGVzY3JpcHRvcik7XG4gICAgICAgIHJldHVybiBhY3RXaXRoKHVud3JhcCh0YXJnZXQpLCAob2JqKT0+UmVmbGVjdC5kZWZpbmVQcm9wZXJ0eShvYmosIHByb3AsIGRlc2NyaXB0b3IpKTtcbiAgICB9XG5cbiAgICAvL1xuICAgIGRlbGV0ZVByb3BlcnR5KHRhcmdldCwgcHJvcCkge1xuICAgICAgICBpZiAodW53cmFwKHRhcmdldCkgaW5zdGFuY2VvZiBQcm9taXNlKSByZXR1cm4gUmVmbGVjdC5kZWxldGVQcm9wZXJ0eSh0YXJnZXQsIHByb3ApO1xuICAgICAgICByZXR1cm4gYWN0V2l0aCh1bndyYXAodGFyZ2V0KSwgKG9iaik9PlJlZmxlY3QuZGVsZXRlUHJvcGVydHkob2JqLCBwcm9wKSk7XG4gICAgfVxuXG4gICAgLy9cbiAgICBnZXRQcm90b3R5cGVPZih0YXJnZXQpIHtcbiAgICAgICAgaWYgKHVud3JhcCh0YXJnZXQpIGluc3RhbmNlb2YgUHJvbWlzZSkgcmV0dXJuIFJlZmxlY3QuZ2V0UHJvdG90eXBlT2YodGFyZ2V0KTtcbiAgICAgICAgcmV0dXJuIGFjdFdpdGgodW53cmFwKHRhcmdldCksIChvYmopPT5SZWZsZWN0LmdldFByb3RvdHlwZU9mKG9iaikpO1xuICAgIH1cblxuICAgIC8vXG4gICAgc2V0UHJvdG90eXBlT2YodGFyZ2V0LCBwcm90bykge1xuICAgICAgICBpZiAodW53cmFwKHRhcmdldCkgaW5zdGFuY2VvZiBQcm9taXNlKSByZXR1cm4gUmVmbGVjdC5zZXRQcm90b3R5cGVPZih0YXJnZXQsIHByb3RvKTtcbiAgICAgICAgcmV0dXJuIGFjdFdpdGgodW53cmFwKHRhcmdldCksIChvYmopPT5SZWZsZWN0LnNldFByb3RvdHlwZU9mKG9iaiwgcHJvdG8pKTtcbiAgICB9XG5cbiAgICAvL1xuICAgIGlzRXh0ZW5zaWJsZSh0YXJnZXQpIHtcbiAgICAgICAgaWYgKHVud3JhcCh0YXJnZXQpIGluc3RhbmNlb2YgUHJvbWlzZSkgcmV0dXJuIFJlZmxlY3QuaXNFeHRlbnNpYmxlKHRhcmdldCk7XG4gICAgICAgIHJldHVybiBhY3RXaXRoKHVud3JhcCh0YXJnZXQpLCAob2JqKT0+UmVmbGVjdC5pc0V4dGVuc2libGUob2JqKSk7XG4gICAgfVxuXG4gICAgLy9cbiAgICBwcmV2ZW50RXh0ZW5zaW9ucyh0YXJnZXQpIHtcbiAgICAgICAgaWYgKHVud3JhcCh0YXJnZXQpIGluc3RhbmNlb2YgUHJvbWlzZSkgcmV0dXJuIFJlZmxlY3Qub3duS2V5cyh0YXJnZXQpO1xuICAgICAgICByZXR1cm4gYWN0V2l0aCh1bndyYXAodGFyZ2V0KSwgKG9iaik9PlJlZmxlY3QucHJldmVudEV4dGVuc2lvbnMob2JqKSk7XG4gICAgfVxuXG4gICAgLy9cbiAgICBvd25LZXlzKHRhcmdldCkge1xuICAgICAgICBjb25zdCB1d3AgPSB1bndyYXAodGFyZ2V0KTtcbiAgICAgICAgaWYgKHV3cCBpbnN0YW5jZW9mIFByb21pc2UpIHJldHVybiBPYmplY3Qua2V5cyh1d3ApO1xuICAgICAgICBjb25zdCBrZXlzID0gYWN0V2l0aCh1d3AsIChvYmopPT57IHJldHVybiAodHlwZW9mIG9iaiA9PSBcIm9iamVjdFwiIHx8IHR5cGVvZiBvYmogPT0gXCJmdW5jdGlvblwiKSAmJiBvYmogIT0gbnVsbCA/IE9iamVjdC5rZXlzKG9iaikgOiBbXSB9KTtcbiAgICAgICAgcmV0dXJuIGtleXMgPz8gW107XG4gICAgfVxuXG4gICAgLy9cbiAgICBnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBwcm9wKSB7XG4gICAgICAgIGlmICh1bndyYXAodGFyZ2V0KSBpbnN0YW5jZW9mIFByb21pc2UpIHJldHVybiBSZWZsZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIHByb3ApO1xuICAgICAgICByZXR1cm4gYWN0V2l0aCh1bndyYXAodGFyZ2V0KSwgKG9iaik9PlJlZmxlY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG9iaiwgcHJvcCkpO1xuICAgIH1cblxuICAgIC8vXG4gICAgY29uc3RydWN0KHRhcmdldCwgYXJncywgbmV3VGFyZ2V0KSB7XG4gICAgICAgIHJldHVybiBhY3RXaXRoKHVud3JhcCh0YXJnZXQpLCAoY3QpPT5SZWZsZWN0LmNvbnN0cnVjdChjdCwgYXJncywgbmV3VGFyZ2V0KSk7XG4gICAgfVxuXG4gICAgLy9cbiAgICBoYXModGFyZ2V0LCBwcm9wKSB7XG4gICAgICAgIGlmICh1bndyYXAodGFyZ2V0KSBpbnN0YW5jZW9mIFByb21pc2UpIHJldHVybiBSZWZsZWN0Lmhhcyh0YXJnZXQsIHByb3ApO1xuICAgICAgICByZXR1cm4gYWN0V2l0aCh1bndyYXAodGFyZ2V0KSwgKG9iaik9PlJlZmxlY3QuaGFzKG9iaiwgcHJvcCkpO1xuICAgIH1cblxuICAgIC8vXG4gICAgZ2V0KHRhcmdldCwgcHJvcCwgcmVjZWl2ZXIpIHtcbiAgICAgICAgdGFyZ2V0ID0gdW53cmFwKHRhcmdldCk7XG5cbiAgICAgICAgLy9cbiAgICAgICAgaWYgKHByb3AgPT0gJ3Byb21pc2UnKSB7IHJldHVybiB0YXJnZXQ7IH0gLy8gQHRzLWlnbm9yZVxuICAgICAgICBpZiAocHJvcCA9PSAncmVzb2x2ZScgJiYgdGhpcy4jcmVzb2x2ZSkgeyByZXR1cm4gKC4uLmFyZ3MpPT57IGNvbnN0IHJlc3VsdCA9IHRoaXMuI3Jlc29sdmU/LiguLi5hcmdzKTsgdGhpcy4jcmVzb2x2ZSA9IG51bGw7IHJldHVybiByZXN1bHQ7IH07IH0gLy8gQHRzLWlnbm9yZVxuICAgICAgICBpZiAocHJvcCA9PSAncmVqZWN0JyAgJiYgdGhpcy4jcmVqZWN0ICkgeyByZXR1cm4gKC4uLmFyZ3MpPT57IGNvbnN0IHJlc3VsdCA9IHRoaXMuI3JlamVjdD8uKC4uLmFyZ3MpOyAgdGhpcy4jcmVqZWN0ICA9IG51bGw7IHJldHVybiByZXN1bHQ7IH07IH0gLy8gQHRzLWlnbm9yZVxuICAgICAgICBpZiAocHJvcCA9PSAndGhlbicgfHwgcHJvcCA9PSAnY2F0Y2gnIHx8IHByb3AgPT0gJ2ZpbmFsbHknKSB7XG4gICAgICAgICAgICBpZiAodGFyZ2V0IGluc3RhbmNlb2YgUHJvbWlzZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0YXJnZXQ/Lltwcm9wXT8uYmluZD8uKHRhcmdldCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnN0ICR0bXAgPSBQcm9taXNlLnRyeSgoKT0+dGFyZ2V0KTtcbiAgICAgICAgICAgICAgICByZXR1cm4gJHRtcD8uW3Byb3BdPy5iaW5kPy4oJHRtcCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IFByb21pc2VkKGFjdFdpdGgodGFyZ2V0LCBhc3luYyAob2JqKT0+e1xuICAgICAgICAgICAgaWYgKHVud3JhcChvYmopIGluc3RhbmNlb2YgUHJvbWlzZSkgcmV0dXJuIFJlZmxlY3QuZ2V0KG9iaiwgcHJvcCwgcmVjZWl2ZXIpO1xuICAgICAgICAgICAgaWYgKGlzUHJpbWl0aXZlKG9iaikpIHsgcmV0dXJuIChwcm9wID09IFN5bWJvbC50b1ByaW1pdGl2ZSB8fCBwcm9wID09IFN5bWJvbC50b1N0cmluZ1RhZykgPyBvYmogOiB1bmRlZmluZWQ7IH1cbiAgICAgICAgICAgIGxldCB2YWx1ZTogYW55ID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgdHJ5IHsgdmFsdWUgPSBSZWZsZWN0LmdldChvYmosIHByb3AsIHJlY2VpdmVyKTsgfSBjYXRjaCAoZSkgeyB2YWx1ZSA9IHRhcmdldD8uW3Byb3BdOyB9XG4gICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09ICdmdW5jdGlvbicpIHsgcmV0dXJuIHZhbHVlPy5iaW5kPy4ob2JqKTsgfVxuICAgICAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgICAgICB9KSk7XG5cbiAgICAgICAgLy9cbiAgICAgICAgaWYgKHByb3AgPT0gU3ltYm9sLnRvU3RyaW5nVGFnKSB7XG4gICAgICAgICAgICBpZiAoaXNQcmltaXRpdmUocmVzdWx0KSkgeyByZXR1cm4gU3RyaW5nKHJlc3VsdCA/PyBcIlwiKSB8fCBcIlwiOyB9O1xuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdD8uW1N5bWJvbC50b1N0cmluZ1RhZ10/LigpIHx8IFN0cmluZyhyZXN1bHQgPz8gXCJcIikgfHwgXCJcIjtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vXG4gICAgICAgIGlmIChwcm9wID09IFN5bWJvbC50b1ByaW1pdGl2ZSkgeyByZXR1cm4gKGhpbnQ/KT0+e1xuICAgICAgICAgICAgaWYgKGlzUHJpbWl0aXZlKHJlc3VsdCkpIHsgcmV0dXJuIHRyeVBhcnNlQnlIaW50KHJlc3VsdCwgaGludCk7IH07XG4gICAgICAgICAgICByZXR1cm4gbnVsbDsvL3RyeVBhcnNlQnlIaW50KHJlc3VsdD8uW1N5bWJvbC50b1ByaW1pdGl2ZV0/LigpKTtcbiAgICAgICAgfX1cblxuICAgICAgICAvL1xuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cblxuICAgIC8vXG4gICAgc2V0KHRhcmdldCwgcHJvcCwgdmFsdWUpIHtcbiAgICAgICAgcmV0dXJuIGFjdFdpdGgodW53cmFwKHRhcmdldCksIChvYmopPT5SZWZsZWN0LnNldChvYmosIHByb3AsIHZhbHVlKSk7XG4gICAgfVxuXG4gICAgLy9cbiAgICBhcHBseSh0YXJnZXQsIHRoaXNBcmcsIGFyZ3MpIHsgLy8gQHRzLWlnbm9yZVxuICAgICAgICBpZiAodGhpcy4jcmVzb2x2ZSkgeyBjb25zdCByZXN1bHQgPSB0aGlzLiNyZXNvbHZlPy4oLi4uYXJncyk7IHRoaXMuI3Jlc29sdmUgPSBudWxsOyByZXR1cm4gcmVzdWx0OyB9XG4gICAgICAgIHJldHVybiBhY3RXaXRoKHVud3JhcCh0YXJnZXQsIHRoaXMuI3Jlc29sdmUpLCAob2JqKSA9PiB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIG9iaiA9PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgICAgICAgICAgICBpZiAodW53cmFwKG9iaikgaW5zdGFuY2VvZiBQcm9taXNlKSByZXR1cm4gUmVmbGVjdC5hcHBseShvYmosIHRoaXNBcmcsIGFyZ3MpO1xuICAgICAgICAgICAgICAgIHJldHVybiBSZWZsZWN0LmFwcGx5KG9iaiwgdGhpc0FyZywgYXJncyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbn1cblxuLyoqXG4gKiBUeXBlIGFsaWFzIGZvciBQcm9taXNlLWxpa2UgdmFsdWVzIChQcm9taXNlIG9yIGFueSB2YWx1ZSkuXG4gKiBAdGVtcGxhdGUgVCAtIFRoZSByZXNvbHZlZCB2YWx1ZSB0eXBlXG4gKi9cbmV4cG9ydCB0eXBlIFByb21pc2VMaWtlPFQ9YW55PiA9IFByb21pc2U8VD58YW55O1xuXG4vKipcbiAqIFdyYXAgYSBwcm9taXNlIG9yIHZhbHVlIGluIGEgUHJveHkgdGhhdCBhbGxvd3Mgc3luY2hyb25vdXMgcHJvcGVydHkgYWNjZXNzLlxuICogRm9yIHJlc29sdmVkIHByb21pc2VzLCB0aGlzIGVuYWJsZXMgYWNjZXNzaW5nIHByb3BlcnRpZXMgYXMgaWYgdGhlIHByb21pc2Ugd2FzIGFscmVhZHkgcmVzb2x2ZWQuXG4gKiBAdGVtcGxhdGUgVCAtIFRoZSByZXNvbHZlZCB2YWx1ZSB0eXBlXG4gKiBAcGFyYW0gcHJvbWlzZSAtIFRoZSBwcm9taXNlIG9yIHZhbHVlIHRvIHdyYXBcbiAqIEBwYXJhbSByZXNvbHZlIC0gT3B0aW9uYWwgcmVzb2x2ZSBjYWxsYmFja1xuICogQHBhcmFtIHJlamVjdCAtIE9wdGlvbmFsIHJlamVjdCBjYWxsYmFja1xuICogQHJldHVybnMgQSBwcm94eSB0aGF0IGFsbG93cyBzeW5jaHJvbm91cy1zdHlsZSBhY2Nlc3MgdG8gcHJvbWlzZSB2YWx1ZXNcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIFByb21pc2VkPFQ9YW55Pihwcm9taXNlOiBQcm9taXNlTGlrZTxUPiwgcmVzb2x2ZT86ICgoLi4uYXJnczogYW55W10pPT52b2lkKXxudWxsLCByZWplY3Q/OiAoKC4uLmFyZ3M6IGFueVtdKT0+dm9pZCl8bnVsbCkge1xuICAgIGlmICghKHByb21pc2UgaW5zdGFuY2VvZiBQcm9taXNlIHx8IHR5cGVvZiBwcm9taXNlPy50aGVuID09IFwiZnVuY3Rpb25cIikpIHsgcmV0dXJuIHByb21pc2U7IH1cbiAgICBpZiAocmVzb2x2ZWRNYXA/Lmhhcz8uKHByb21pc2UpKSB7IHJldHVybiByZXNvbHZlZE1hcD8uZ2V0Py4ocHJvbWlzZSk7IH07XG4gICAgaWYgKCFoYW5kbGVkTWFwPy5oYXM/Lihwcm9taXNlKSkgeyBwcm9taXNlPy50aGVuPy4oKGl0ZW0pPT5yZXNvbHZlZE1hcD8uc2V0Py4ocHJvbWlzZSwgaXRlbSkpOyB9IC8vIEB0cy1pZ25vcmVcbiAgICByZXR1cm4gaGFuZGxlZE1hcD8uZ2V0T3JJbnNlcnRDb21wdXRlZD8uKHByb21pc2UsICgpPT5uZXcgUHJveHk8UHJvbWlzZUxpa2U8VD4+KGZpeEZ4KHByb21pc2UpLCBuZXcgUHJvbWlzZUhhbmRsZXIocmVzb2x2ZSwgcmVqZWN0KSkpO1xufVxuXG4vL2lmIChbXCJ0aGVuXCIsIFwiY2F0Y2hcIiwgXCJmaW5hbGx5XCJdLmluY2x1ZGVzKHByb3AgYXMgc3RyaW5nKSkgeyByZXR1cm4gKHR5cGVvZiB3aXRoVXBkYXRlPy5bcHJvcF0gPT0gXCJmdW5jdGlvblwiID8gd2l0aFVwZGF0ZT8uW3Byb3BdPy5iaW5kPy4od2l0aFVwZGF0ZSkgOiB3aXRoVXBkYXRlPy5bcHJvcF0pOyB9XG4iXX0=